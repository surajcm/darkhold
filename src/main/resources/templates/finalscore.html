<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Final Results - Darkhold classroom quiz experience</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#0062cc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Darkhold Quiz">
    <link rel="shortcut icon" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/images/icons/icon-192.png">
    <link href="/styles/darkhold-styles.css" rel="stylesheet" />
    <link href="/styles/team-styles.css" rel="stylesheet" />
    <script type="text/javascript" src="/scripts/theme-manager.js"></script>
    <script type="text/javascript" src="/scripts/audio-manager.js"></script>
    <script type="text/javascript" src="/scripts/accessibility.js"></script>
    <script type="text/javascript" src="/scripts/common-scripts.js"></script>
    <style>
        .podium-container { display: flex; justify-content: center; align-items: flex-end; margin: 40px 0; }
        .podium-place { text-align: center; margin: 0 10px; animation: slideUp 0.8s ease-out; }
        .podium-place.first { order: 2; }
        .podium-place.second { order: 1; }
        .podium-place.third { order: 3; }
        .podium-block { padding: 20px 30px; border-radius: 8px 8px 0 0; color: white; min-width: 120px; }
        .podium-block.gold { background: linear-gradient(135deg, #FFD700, #FFA500); height: 150px; }
        .podium-block.silver { background: linear-gradient(135deg, #C0C0C0, #A8A8A8); height: 120px; }
        .podium-block.bronze { background: linear-gradient(135deg, #CD7F32, #8B4513); height: 90px; }
        .podium-rank { font-size: 2.5rem; font-weight: bold; margin-bottom: 5px; }
        .podium-name { font-size: 1.2rem; font-weight: 500; word-break: break-word; }
        .podium-score { font-size: 1rem; opacity: 0.9; }
        .trophy { font-size: 3rem; margin-bottom: 10px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        .confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        .remaining-scores { margin-top: 30px; }
        .winner-announcement { font-size: 1.5rem; text-align: center; margin-bottom: 20px; color: #333; }
    </style>
</head>
<body>
    <div th:insert="~{navbar :: navbar}"></div>
    <nav class="navbar transparent">
        <ul class="navbar-nav mx-auto">
            <li class="nav-item">
                <span class="badge badge-pill badge-primary" style="font-size: 1.5rem;">Final Results</span>
            </li>
        </ul>
    </nav>
    <form action="#" th:object="${score}" method="post">
        <div id="wrapper">
            <div id="page-content-wrapper">
                <div class="container-fluid">
                    <div class="container">
                        <!-- Team Mode Badge -->
                        <div th:if="${isTeamMode}" class="text-center mb-3">
                            <span class="badge bg-info" style="font-size: 1rem;">Team Mode Results</span>
                        </div>

                        <!-- Winner Announcement -->
                        <div class="winner-announcement victory-message" th:if="${score.score != null and !score.score.isEmpty()}" role="status" aria-live="polite">
                            <span th:if="${isTeamMode and teamScores != null and !teamScores.isEmpty()}">
                                Congratulations to the winning team!
                            </span>
                            <span th:unless="${isTeamMode and teamScores != null and !teamScores.isEmpty()}">
                                Congratulations to our winner!
                            </span>
                        </div>

                        <!-- Team Podium (shown when team mode is enabled) -->
                        <div th:if="${isTeamMode and teamScores != null and !teamScores.isEmpty()}">
                            <h4 class="text-center mb-3">Team Results</h4>
                            <div class="team-podium-container">
                                <!-- 2nd Place Team -->
                                <div class="team-podium-place second" th:if="${#lists.size(teamScores) > 1}">
                                    <div class="trophy">&#129352;</div>
                                    <div th:class="'team-podium-block silver team-card-' + ${teamScores[1].color}">
                                        <div class="team-podium-rank">2nd</div>
                                        <div class="team-podium-name" th:text="${teamScores[1].teamName}"></div>
                                        <div class="team-podium-score" th:text="${teamScores[1].totalScore} + ' pts'"></div>
                                        <div class="team-podium-members" th:text="${teamScores[1].memberCount} + ' members'"></div>
                                    </div>
                                </div>

                                <!-- 1st Place Team (with celebration effects) -->
                                <div class="team-podium-place first" th:if="${#lists.size(teamScores) > 0}">
                                    <div class="trophy">&#127942;</div>
                                    <div th:class="'team-podium-block gold team-card-' + ${teamScores[0].color} + ' team-winner-celebration team-winner-' + ${teamScores[0].color}"
                                         th:data-winner-color="${teamScores[0].color}">
                                        <div class="team-podium-rank">1st</div>
                                        <div class="team-podium-name" th:text="${teamScores[0].teamName}"></div>
                                        <div class="team-podium-score" th:text="${teamScores[0].totalScore} + ' pts'"></div>
                                        <div class="team-podium-members" th:text="${teamScores[0].memberCount} + ' members'"></div>
                                        <div class="team-victory-badge">WINNERS!</div>
                                    </div>
                                </div>

                                <!-- 3rd Place Team -->
                                <div class="team-podium-place third" th:if="${#lists.size(teamScores) > 2}">
                                    <div class="trophy">&#129353;</div>
                                    <div th:class="'team-podium-block bronze team-card-' + ${teamScores[2].color}">
                                        <div class="team-podium-rank">3rd</div>
                                        <div class="team-podium-name" th:text="${teamScores[2].teamName}"></div>
                                        <div class="team-podium-score" th:text="${teamScores[2].totalScore} + ' pts'"></div>
                                        <div class="team-podium-members" th:text="${teamScores[2].memberCount} + ' members'"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Confetti container for team wins -->
                            <div id="teamConfetti" class="confetti-container"></div>
                        </div>

                        <!-- Individual Podium Header -->
                        <h4 th:if="${isTeamMode}" class="text-center mb-3 mt-4">Individual Results</h4>

                        <!-- Podium for top 3 -->
                        <div class="podium-container" th:if="${score.sortedScores != null and !score.sortedScores.isEmpty()}">
                            <!-- 2nd Place -->
                            <div class="podium-place second" th:if="${#lists.size(score.sortedScores) > 1}">
                                <div class="trophy">&#129352;</div>
                                <div class="podium-block silver">
                                    <div class="podium-rank">2nd</div>
                                    <div class="podium-name" th:text="${score.sortedScores[1].key}"></div>
                                    <div class="podium-score" th:text="${score.sortedScores[1].value} + ' pts'"></div>
                                </div>
                            </div>

                            <!-- 1st Place -->
                            <div class="podium-place first" th:if="${#lists.size(score.sortedScores) > 0}">
                                <div class="trophy">&#127942;</div>
                                <div class="podium-block gold">
                                    <div class="podium-rank">1st</div>
                                    <div class="podium-name" th:text="${score.sortedScores[0].key}"></div>
                                    <div class="podium-score" th:text="${score.sortedScores[0].value} + ' pts'"></div>
                                </div>
                            </div>

                            <!-- 3rd Place -->
                            <div class="podium-place third" th:if="${#lists.size(score.sortedScores) > 2}">
                                <div class="trophy">&#129353;</div>
                                <div class="podium-block bronze">
                                    <div class="podium-rank">3rd</div>
                                    <div class="podium-name" th:text="${score.sortedScores[2].key}"></div>
                                    <div class="podium-score" th:text="${score.sortedScores[2].value} + ' pts'"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Full leaderboard -->
                        <div class="remaining-scores" th:if="${score.score != null and !score.score.isEmpty()}">
                            <h4 class="text-center mb-3">Full Leaderboard</h4>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th style="width: 60px;">Rank</th>
                                        <th>Player</th>
                                        <th style="text-align: right;">Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="entry, stat : ${score.sortedScores}"
                                        th:classappend="${stat.index < 3} ? 'table-warning' : ''">
                                        <td th:text="${stat.index + 1}"></td>
                                        <td th:text="${entry.key}"></td>
                                        <td style="text-align: right;" th:text="${entry.value}"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- No scores message -->
                        <div class="text-center my-5" th:if="${score.score == null or score.score.isEmpty()}">
                            <h3>No scores to display</h3>
                            <p>The game ended without any scores recorded.</p>
                        </div>

                        <!-- Return button -->
                        <div class="text-center mt-4 mb-4">
                            <button type="button" class="btn btn-lg btn-primary" onclick="window.location.href='/'">
                                Return to Home
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <script type="text/javascript" src="/scripts/core/popper.min.js"></script>
    <script type="text/javascript" src="/scripts/core/bootstrap-5.3.1/bootstrap.min.js"></script>
    <script>
        // Play victory/defeat sound and add trophy animation
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is authenticated and if there are scores
            const trophies = document.querySelectorAll('.trophy');
            trophies.forEach(trophy => {
                trophy.classList.add('trophy-icon');
            });

            // Play victory sound if there are winners
            const hasWinners = document.querySelector('.podium-container') !== null;
            if (hasWinners && typeof AudioManager !== 'undefined') {
                AudioManager.playVictory();
            }

            // Team win celebration
            const teamWinner = document.querySelector('.team-winner-celebration');
            if (teamWinner) {
                createTeamConfetti(teamWinner.getAttribute('data-winner-color'));
                // Play team victory sound
                if (typeof AudioManager !== 'undefined') {
                    AudioManager.playVictory();
                }
            }

            // Announce results for screen readers
            if (typeof A11y !== 'undefined') {
                const teamWinnerName = document.querySelector('.team-winner-celebration .team-podium-name');
                const winnerElement = document.querySelector('.podium-name');
                if (teamWinnerName) {
                    const name = teamWinnerName.textContent.trim();
                    A11y.announce('Game complete! The winning team is ' + name);
                } else if (winnerElement) {
                    const winnerName = winnerElement.textContent.trim();
                    A11y.announce('Game complete! The winner is ' + winnerName);
                } else {
                    A11y.announce('Game complete! Final results are displayed');
                }
            }
        });

        function createTeamConfetti(teamColor) {
            const container = document.getElementById('teamConfetti');
            if (!container) return;

            const colors = getConfettiColors(teamColor);
            const pieceCount = 50;

            for (let i = 0; i < pieceCount; i++) {
                setTimeout(() => {
                    const piece = document.createElement('div');
                    piece.className = 'confetti-piece';
                    piece.style.left = Math.random() * 100 + '%';
                    piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    piece.style.animationDelay = Math.random() * 0.5 + 's';
                    piece.style.animationDuration = (2 + Math.random() * 2) + 's';
                    piece.style.width = (5 + Math.random() * 10) + 'px';
                    piece.style.height = (5 + Math.random() * 10) + 'px';
                    piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                    container.appendChild(piece);

                    // Remove after animation
                    setTimeout(() => piece.remove(), 5000);
                }, i * 50);
            }
        }

        function getConfettiColors(teamColor) {
            const teamColors = {
                'red': ['#dc3545', '#ff6b7a', '#ffd700', '#ffffff'],
                'blue': ['#0062cc', '#4d94ff', '#ffd700', '#ffffff'],
                'green': ['#28a745', '#5cd65c', '#ffd700', '#ffffff'],
                'yellow': ['#ffc107', '#ffdb4d', '#ff9500', '#ffffff'],
                'purple': ['#9c27b0', '#ce93d8', '#ffd700', '#ffffff'],
                'orange': ['#ff7c0c', '#ffa64d', '#ffd700', '#ffffff']
            };
            return teamColors[teamColor] || ['#ffd700', '#ff9500', '#ffffff', '#ffeb3b'];
        }
    </script>
</body>
</html>